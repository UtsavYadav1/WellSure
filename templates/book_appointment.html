<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Book Appointment - MediSense</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #miniMap {
            height: 200px;
            width: 100%;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }
    </style>
</head>

<body>

    <!-- Standard Global Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fa-solid fa-brain-circuit"></i> MediSense
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/view_doctors">Doctors</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <button class="theme-btn me-3" id="themeToggle" title="Toggle Theme"><i
                            class="fa-solid fa-moon"></i></button>
                    <a href="/patient_dashboard" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card-pro p-0 overflow-hidden">
                    <div class="p-4 bg-primary bg-opacity-10 border-bottom border-secondary border-opacity-10">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="col-md-6">
                                    <h6 class="text-uppercase text-secondary small fw-bold mb-3">Clinic Location</h6>
                                    <div id="miniMap" class="mb-2"></div>
                                    <p class="small text-secondary mb-0"><i class="fa-solid fa-location-dot me-1"></i>
                                        {{
                                        doctor.address }}, {{ doctor.city }}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-uppercase text-secondary small fw-bold mb-3">Your Details</h6>
                                    <div class="bg-surface p-3 rounded-3 border border-secondary border-opacity-10">
                                        <p class="mb-1 text-main fw-medium">{{ session.name }}</p>
                                        <p class="mb-1 small text-secondary">Logged in as Patient</p>
                                        <hr class="border-secondary opacity-25 my-2">
                                        <p class="mb-0 small text-muted"><i class="fa-solid fa-circle-info me-1"></i>
                                            Please
                                            ensure your contact details in your profile are up to date.</p>
                                    </div>
                                </div>
                            </div>

                            <form action="/confirm_booking" method="post">
                                <h5 class="mb-3 text-main">Select Date & Time</h5>

                                <!-- Context from AI Prediction -->
                                <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
                                <input type="hidden" name="symptom_log_id"
                                    value="{{ request.args.get('log_id') or '' }}">
                                <input type="hidden" name="doctor_specialization" value="{{ doctor.specialization }}">

                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Appointment Date</label>
                                        <input type="date" name="appointment_date" class="form-control" required
                                            min="{{ get_today_date() }}">
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between">
                                            <label class="form-label">Time Slot</label>
                                            <small class="text-muted">Avail: {{ doctor.available_start_time }} - {{
                                                doctor.available_end_time }}</small>
                                        </div>
                                        <input type="time" name="appointment_time" class="form-control" required>
                                    </div>
                                </div>

                                <!-- Payment Method Selection -->
                                <div class="mb-4">
                                    <label class="form-label fw-medium">Payment Method</label>
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="payment_mode" id="pay_clinic"
                                                value="at_clinic" checked>
                                            <label class="btn btn-outline-secondary w-100 py-3" for="pay_clinic">
                                                <i class="fa-solid fa-building-columns me-2"></i>
                                                <span class="d-block fw-medium">Pay at Clinic</span>
                                                <small class="text-muted">Pay during visit</small>
                                            </label>
                                        </div>
                                        <div class="col-6">
                                            <input type="radio" class="btn-check" name="payment_mode" id="pay_online"
                                                value="online">
                                            <label class="btn btn-outline-success w-100 py-3" for="pay_online">
                                                <i class="fa-solid fa-credit-card me-2"></i>
                                                <span class="d-block fw-medium">Pay Now</span>
                                                <small class="text-success">₹{{ doctor.fees }} • Secure</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Online Payment Form (Hidden by default) -->
                                <div id="onlinePaymentSection" class="mb-4" style="display: none;">
                                    <div class="card payment-card border p-4 rounded-3"
                                        style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-color: rgba(255,255,255,0.1) !important;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="fw-medium text-main"><i
                                                    class="fa-solid fa-lock me-2 text-success"></i>Secure Payment</span>
                                            <div class="d-flex gap-2">
                                                <img src="https://img.icons8.com/color/32/visa.png" alt="Visa"
                                                    style="height: 20px;">
                                                <img src="https://img.icons8.com/color/32/mastercard.png"
                                                    alt="Mastercard" style="height: 20px;">
                                                <img src="https://img.icons8.com/color/32/rupay.png" alt="RuPay"
                                                    style="height: 20px;">
                                            </div>
                                        </div>

                                        <!-- Payment Method Tabs -->
                                        <ul class="nav nav-pills nav-fill mb-3" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button type="button" class="nav-link active small py-2"
                                                    data-bs-toggle="pill" data-bs-target="#cardTab">
                                                    <i class="fa-regular fa-credit-card me-1"></i>Card
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button type="button" class="nav-link small py-2" data-bs-toggle="pill"
                                                    data-bs-target="#upiTab">
                                                    <i class="fa-solid fa-mobile-screen me-1"></i>UPI
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content">
                                            <!-- Card Payment Tab -->
                                            <div class="tab-pane fade show active" id="cardTab">
                                                <div class="mb-3">
                                                    <label class="form-label small" style="color: #adb5bd;">Card
                                                        Number</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #adb5bd;">
                                                            <i class="fa-regular fa-credit-card"></i>
                                                        </span>
                                                        <input type="text" class="form-control"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff;"
                                                            placeholder="1234 5678 9012 3456" maxlength="19"
                                                            oninput="this.value = this.value.replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim()">
                                                    </div>
                                                </div>
                                                <div class="row g-2">
                                                    <div class="col-6">
                                                        <label class="form-label small"
                                                            style="color: #adb5bd;">Expiry</label>
                                                        <input type="text" class="form-control"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff;"
                                                            placeholder="MM/YY" maxlength="5"
                                                            oninput="this.value = this.value.replace(/[^\d]/g, '').replace(/^(\d{2})/, '$1/').substr(0, 5)">
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small"
                                                            style="color: #adb5bd;">CVV</label>
                                                        <input type="password" class="form-control"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff;"
                                                            placeholder="•••" maxlength="3">
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <label class="form-label small" style="color: #adb5bd;">Name on
                                                        Card</label>
                                                    <input type="text" class="form-control"
                                                        style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff; text-transform: uppercase;"
                                                        placeholder="JOHN DOE">
                                                </div>
                                            </div>

                                            <!-- UPI Payment Tab -->
                                            <div class="tab-pane fade" id="upiTab">
                                                <div class="mb-3">
                                                    <label class="form-label small" style="color: #adb5bd;">UPI
                                                        ID</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                                                            <img src="https://img.icons8.com/color/24/bhim-upi.png"
                                                                alt="UPI" style="height: 18px;">
                                                        </span>
                                                        <input type="text" class="form-control"
                                                            style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: #fff;"
                                                            placeholder="yourname@upi">
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2 flex-wrap">
                                                    <img src="https://img.icons8.com/color/48/google-pay-india.png"
                                                        alt="GPay" style="height: 36px; cursor: pointer; opacity: 0.7;"
                                                        class="hover-opacity">
                                                    <img src="https://img.icons8.com/color/48/phone-pe.png"
                                                        alt="PhonePe"
                                                        style="height: 36px; cursor: pointer; opacity: 0.7;"
                                                        class="hover-opacity">
                                                    <img src="https://img.icons8.com/color/48/paytm.png" alt="Paytm"
                                                        style="height: 36px; cursor: pointer; opacity: 0.7;"
                                                        class="hover-opacity">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-3 pt-3 border-top border-secondary border-opacity-25">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-muted small">Amount to pay</span>
                                                <span class="fw-bold text-success fs-5">₹{{ doctor.fees }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-center mt-2 mb-0 small text-muted">
                                        <i class="fa-solid fa-shield-halved me-1 text-success"></i>
                                        256-bit SSL Encrypted • Demo Mode (No real payment)
                                    </p>
                                </div>

                                <div class="alert alert-info border-0 bg-opacity-10 small mb-4" id="feeInfo">
                                    <i class="fa-solid fa-circle-info me-2"></i>
                                    <strong>Consultation Fee:</strong> ₹{{ doctor.fees or 'To be discussed' }}
                                </div>

                                <button type="submit" class="btn btn-primary-gradient w-100 py-3 shadow-lg"
                                    id="submitBtn">
                                    <i class="fa-solid fa-calendar-check me-2"></i><span id="btnText">Confirm
                                        Booking</span>
                                </button>
                                <p class="text-center mt-3 mb-0 small text-muted">
                                    You will receive a confirmation after doctor approval.
                                </p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
        <script>
            var lat = {{ doctor.lat if doctor.lat else 'null' }};
            var lng = {{ doctor.lng if doctor.lng else 'null' }};
            var center = [20.5937, 78.9629];
            if (lat && lng) center = [lat, lng];

            var map = L.map('miniMap', { zoomControl: false }).setView(center, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            if (lat && lng) L.marker(center).addTo(map);

            // Payment Method Toggle
            const payOnline = document.getElementById('pay_online');
            const payClinic = document.getElementById('pay_clinic');
            const paymentSection = document.getElementById('onlinePaymentSection');
            const feeInfo = document.getElementById('feeInfo');
            const btnText = document.getElementById('btnText');
            const submitBtn = document.getElementById('submitBtn');

            function updatePaymentUI() {
                if (payOnline.checked) {
                    paymentSection.style.display = 'block';
                    feeInfo.style.display = 'none';
                    btnText.innerHTML = 'Pay ₹{{ doctor.fees }} & Book';
                    submitBtn.classList.remove('btn-primary-gradient');
                    submitBtn.classList.add('btn-success');
                } else {
                    paymentSection.style.display = 'none';
                    feeInfo.style.display = 'block';
                    btnText.innerHTML = 'Confirm Booking';
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-primary-gradient');
                }
            }

            payOnline.addEventListener('change', updatePaymentUI);
            payClinic.addEventListener('change', updatePaymentUI);
        </script>
</body>

</html>