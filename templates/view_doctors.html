<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Find Doctors - MediSense</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }
    </style>
</head>

<body>

    <!-- Standard Global Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="MediSense"
                    style="height: 42px; width: 42px; object-fit: cover; margin-right: 12px; border-radius: 50%;">
                <span>MediSense</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/view_doctors">Doctors</a></li>
                    {% if session.name %}
                    <li class="nav-item"><a class="nav-link" href="/my_appointments">Appointments</a></li>
                    {% endif %}
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <button class="theme-btn me-3" id="themeToggle" title="Toggle Theme"><i
                            class="fa-solid fa-moon"></i></button>
                    {% if session.name %}
                    <a href="/patient_dashboard" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                    {% else %}
                    <a href="/login" class="btn btn-primary-gradient btn-sm">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-4">

        <!-- Navigation Fix: Back Button (Using /view_diagnosis/ via GET) -->
        {% if request.args.get('log_id') %}
        <div class="mb-4">
            <a href="/view_diagnosis/{{ request.args.get('log_id') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-arrow-left me-2"></i> Back to Diagnosis Result
            </a>
        </div>
        {% endif %}

        <h2 class="mb-4 fw-bold text-main">Find Specialists Near You</h2>

        <!-- Search & Filter -->
        <div class="glass-container mb-5 p-4">
            <form class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Search by Name or City</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="e.g. Dr. Smith, Delhi">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Specialist</label>
                    <select class="form-select" id="specialityInput">
                        <option value="">All Specialities</option>
                        {% for spec in specializations %}
                        <option value="{{ spec }}">{{ spec }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary-gradient w-100" onclick="filterDoctors()">Apply
                        Filters</button>
                </div>
            </form>
        </div>

        <div class="row g-4">
            <!-- Doctor List -->
            <div class="col-lg-6">
                <div class="row g-3" id="doctorsList">
                    {% for doc in doctors %}
                    <div class="col-12 doctor-card-container" data-name="{{ doc.name.lower() }}"
                        data-city="{{ doc.city.lower() }}" data-speciality="{{ doc.specialization }}">
                        <div class="card-pro p-3 h-100 d-flex flex-row align-items-center">
                            <div class="me-3 flex-shrink-0">
                                {% if doc.profile_pic %}
                                <img src="{{ url_for('static', filename='uploads/profile_pics/' + doc.profile_pic) }}"
                                    alt="Doctor" class="rounded-circle"
                                    style="width: 60px; height: 60px; object-fit: cover;">
                                {% else %}
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary d-flex align-items-center justify-content-center"
                                    style="width: 60px; height: 60px;">
                                    <i class="fa-solid fa-user-doctor fa-2x"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1 fw-bold text-main">{{ doc.name }}</h5>
                                <p class="text-primary mb-1 small text-uppercase fw-bold">{{ doc.specialization }}</p>
                                <p class="mb-1 small text-secondary"><i class="fa-solid fa-location-dot me-1"></i> {{
                                    doc.city }} - {{ doc.address }}</p>
                                <div class="d-flex align-items-center mt-2">
                                    <span class="badge bg-warning text-dark me-2 ms-0"><i
                                            class="fa-solid fa-star me-1"></i>{{ (doc.rating_average or 0)|round(1)
                                        }}</span>
                                    <span class="small text-muted">₹{{ doc.fees }} Consultation</span>
                                </div>
                            </div>
                            <div class="ms-3 text-end">
                                <a href="/book_appointment/{{ doc.id }}{% if request.args.get('log_id') %}?log_id={{ request.args.get('log_id') }}{% endif %}"
                                    class="btn btn-sm btn-outline-secondary text-nowrap mb-2">Book Now</a>
                                {% if doc.distance is defined and doc.distance < 9999 %} <div
                                    class="badge bg-surface text-secondary border border-secondary border-opacity-25">
                                    <i class="fa-solid fa-person-walking me-1"></i>{{ doc.distance|round(1) }} km
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Map View -->
        <div class="col-lg-6">
            <div class="sticky-top" style="top: 100px; z-index: 900;">
                <div id="map"></div>
                <div class="mt-3 text-end">
                    <small class="text-secondary"><i class="fa-solid fa-info-circle me-1"></i> Map shows doctors
                        based on registered addresses.</small>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        // Global Data
        var doctorsData = {{ doctors | tojson }};
        var patientCoords = {{ patient_coords | tojson if patient_coords else 'null' }};
        var map;
        var doctorLayer = L.layerGroup();
        var patientLayer = L.layerGroup();

        // Icons
        var patientIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', // Green for patient
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        var doctorIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', // Blue for doctors
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        function initMap() {
            // Default center (India approx)
            var center = [20.5937, 78.9629];
            if (patientCoords && patientCoords.lat && patientCoords.lng) {
                center = [patientCoords.lat, patientCoords.lng];
            }

            map = L.map('map').setView(center, 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            doctorLayer.addTo(map);
            patientLayer.addTo(map);

            // Plot Patient
            if (patientCoords && patientCoords.lat && patientCoords.lng) {
                L.marker([patientCoords.lat, patientCoords.lng], { icon: patientIcon })
                    .bindPopup("<b>You are here</b>")
                    .addTo(patientLayer);
            }

            // Initial Plot of All Doctors
            updateMapMarkers(doctorsData);
        }

        function updateMapMarkers(filteredDoctors) {
            doctorLayer.clearLayers();
            var bounds = [];

            if (patientCoords && patientCoords.lat && patientCoords.lng) {
                bounds.push([patientCoords.lat, patientCoords.lng]);
            }

            filteredDoctors.forEach(doc => {
                if (doc.lat && doc.lng) {
                    var distInfo = doc.distance ? `<br>Distance: ${parseFloat(doc.distance).toFixed(1)} km` : '';
                    var marker = L.marker([doc.lat, doc.lng], { icon: doctorIcon })
                        .bindPopup(`<b>${doc.name}</b><br>${doc.specialization}<br>${doc.city}${distInfo}`);
                    marker.addTo(doctorLayer);
                    bounds.push([doc.lat, doc.lng]);
                }
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function filterDoctors() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const speciality = document.getElementById('specialityInput').value;
            const cards = document.querySelectorAll('.doctor-card-container');

            // Filter UI Cards
            cards.forEach(card => {
                const name = card.dataset.name;
                const city = card.dataset.city;
                const spec = card.dataset.speciality;

                let matchesSearch = name.includes(search) || city.includes(search);
                let matchesSpec = speciality === "" || spec === speciality;

                if (matchesSearch && matchesSpec) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            });

            // Filter Map Data
            const filteredData = doctorsData.filter(doc => {
                let name = doc.name.toLowerCase();
                let city = doc.city.toLowerCase();
                let spec = doc.specialization; // Case sensitive usually fine here as source is controlled

                let matchesSearch = name.includes(search) || city.includes(search);
                let matchesSpec = speciality === "" || spec === speciality;
                return matchesSearch && matchesSpec;
            });

            updateMapMarkers(filteredData);
        }

        // Init
        document.addEventListener('DOMContentLoaded', initMap);

    </script>
</body>

</html>
